<!DOCTYPE html>
<html class="scroll-smooth" data-auto-appearance="false" data-default-appearance="dark" dir="ltr" lang="CN"><head>
<script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?f260c483ac9fab4fdd9fd55057878c8c";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
<meta charset="utf-8"/>
<meta content="zh-cn" http-equiv="content-language"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="ie=edge" http-equiv="X-UA-Compatible"/>
<title>堆基础知识学习记录 · ta0lve</title>
<meta content="堆基础知识学习记录 · ta0lve" name="title"/>
<meta content="CTF, PWN, heap, " name="keywords"/>
<link href="https://ta0lve.github.io/posts/pwn/heap/chunk_1/" rel="canonical"/>
<link href="/css/main.bundle.min.c6116b9ed1c907a8c0eb015f377d3eecc07e448d75729e31fc3de5881465c6c172ba9fa9a6800c030116caf2a110d92242bb816639484ca791f7cd107a8d49b5.css" integrity="sha512-xhFrntHJB6jA6wFfN30+7MB+RI11cp4x/D3liBRlxsFyup+ppoAMAwEWyvKhENkiQruBZjlITKeR980Qeo1JtQ==" rel="stylesheet" type="text/css"/>
<script integrity="sha512-UWoWdFvqWpvQERONJUzA/TlzzVXObhXz3sdj58fCx0SPj+e1TMqBHLghsMfhLNFhyqzh3XlKw9NNQJN8vMnuEg==" src="/js/appearance.min.516a16745bea5a9bd011138d254cc0fd3973cd55ce6e15f3dec763e7c7c2c7448f8fe7b54cca811cb821b0c7e12cd161caace1dd794ac3d34d40937cbcc9ee12.js" type="text/javascript"></script>
<script data-copied="" data-copy="" defer="" id="script-bundle" integrity="sha512-PdzwT1sNTDL3LnJtPBLuvM2MPJ+dqpoTQUgIiV3grh4c3d2mhJaA1b2W27YNCx4LJMKfXIPlYx5V5+a8AgFUkA==" src="/js/main.bundle.min.3ddcf04f5b0d4c32f72e726d3c12eebccd8c3c9f9daa9a13414808895de0ae1e1cdddda6849680d5bd96dbb60d0b1e0b24c29f5c83e5631e55e7e6bc02015490.js" type="text/javascript"></script>
<script src="/js/zoom.min.js"></script>
<link href="/apple-touch-icon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="/favicon-32x32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="/favicon-16x16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="/site.webmanifest" rel="manifest"/>
<meta content="堆基础知识学习记录" property="og:title"/>
<meta content="如果本博客部分文章图片加载失败， 可以点击此处查看解决办法 堆的" property="og:description"/>
<meta content="article" property="og:type"/>
<meta content="https://ta0lve.github.io/posts/pwn/heap/chunk_1/" property="og:url"/><meta content="https://ta0lve.github.io/posts/pwn/heap/chunk_1/featured.png" property="og:image"/><meta content="posts" property="article:section"/>
<meta content="2023-07-31T00:00:00+00:00" property="article:published_time"/>
<meta content="2023-07-31T00:00:00+00:00" property="article:modified_time"/>
<meta content="summary_large_image" name="twitter:card"/>
<meta content="https://ta0lve.github.io/posts/pwn/heap/chunk_1/featured.png" name="twitter:image"/>
<meta content="堆基础知识学习记录" name="twitter:title"/>
<meta content="如果本博客部分文章图片加载失败， 可以点击此处查看解决办法 堆的" name="twitter:description"/>
<script type="application/ld+json">
  [{
    "@context": "https://schema.org",
    "@type": "Article",
    "articleSection": "Posts",
    "name": "堆基础知识学习记录",
    "headline": "堆基础知识学习记录",
    
    "abstract": "如果本博客部分文章图片加载失败， 可以点击此处查看解决办法 堆的",
    "inLanguage": "zh-cn",
    "url" : "https:\/\/ta0lve.github.io\/posts\/pwn\/heap\/chunk_1\/",
    "author" : {
      "@type": "Person",
      "name": "ta0lve"
    },
    "copyrightYear": "2023",
    "dateCreated": "2023-07-31T00:00:00\u002b00:00",
    "datePublished": "2023-07-31T00:00:00\u002b00:00",
    
    "dateModified": "2023-07-31T00:00:00\u002b00:00",
    
    "keywords": ["CTF","PWN","heap"],
    
    "mainEntityOfPage": "true",
    "wordCount": "9063"
  }]
  </script>
<meta content="ta0lve" name="author"/>
<link href="mailto:hujt25@mail2.sysu.edu.cn" rel="me"/>
<link href="https://ta0lve.github.io/" rel="me"/>
<link href="https://github.com/ta0lve" rel="me"/>
<script integrity="" src="/lib/jquery/jquery.slim.min.js"></script>
<meta name="theme-color"/>
</head>
<body class="flex flex-col h-screen px-6 m-auto text-lg leading-7 max-w-7xl bg-neutral text-neutral-900 dark:bg-neutral-800 dark:text-neutral sm:px-14 md:px-24 lg:px-32">
<div class="absolute flex self-center" id="the-top">
<a class="px-3 py-1 text-sm -translate-y-8 rounded-b-lg bg-primary-200 focus:translate-y-0 dark:bg-neutral-600" href="#main-content"><span class="font-bold text-primary-600 ltr:pr-2 rtl:pl-2 dark:text-primary-400">↓</span></a>
</div>
<div class="min-h-[148px]"></div>
<div class="fixed inset-x-0 pl-[24px] pr-[24px]" style="z-index:100">
<div class="absolute opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl shadow-2xl" id="menu-blur"></div>
<div class="relative max-w-[64rem] ml-auto mr-auto">
<div class="main-menu flex items-center justify-between px-4 py-6 sm:px-6 md:justify-start space-x-3" style="padding-left:0;padding-right:0;padding-top:2px;padding-bottom:3px">
<div class="flex flex-1 items-center justify-between">
<nav class="flex space-x-3">
<a class="text-base font-medium text-gray-500 hover:text-gray-900" href="/">ta0lve</a>
</nav>
<nav class="hidden md:flex items-center space-x-5 md:ml-12 h-12">
<a class="flex items-center" href="/posts/">
<p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Posts">
        Posts
    </p>
</a>
<a class="flex items-center" href="/categories/">
<p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Categories">
        分类
    </p>
</a>
<a class="flex items-center" href="/tags/">
<p class="text-base font-medium text-gray-500 hover:text-gray-900" title="Tags">
        标签
    </p>
</a>
<a class="flex items-center" href="/link/">
<p class="text-base font-medium text-gray-500 hover:text-gray-900" title="友链/links">
        友链
    </p>
</a>
<a class="flex items-center" href="/about/">
<p class="text-base font-medium text-gray-500 hover:text-gray-900" title="About">
        About
    </p>
</a>
<button aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400 h-12" id="search-button" title="">
<span class="relative block icon">
<svg aria-hidden="true" class="svg-inline--fa fa-search fa-w-16" data-icon="search" data-prefix="fas" focusable="false" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" fill="currentColor"></path></svg>
</span>
</button>
<div class="ltr:mr-14 rtl:ml-14 cursor-pointer text-sm text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400">
<button aria-label="Dark mode switcher" id="appearance-switcher" type="button">
<div class="flex items-center justify-center h-12 dark:hidden">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z" fill="currentColor"></path></svg>
</span>
</div>
<div class="items-center justify-center hidden h-12 dark:flex">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z" fill="currentColor"></path></svg>
</span>
</div>
</button>
</div>
</nav>
<div class="flex md:hidden items-center space-x-5 md:ml-12">
<span></span>
<button aria-label="Search" class="text-base hover:text-primary-600 dark:hover:text-primary-400" id="search-button-mobile" title="">
<span class="relative block icon">
<svg aria-hidden="true" class="svg-inline--fa fa-search fa-w-16" data-icon="search" data-prefix="fas" focusable="false" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" fill="currentColor"></path></svg>
</span>
</button>
<button aria-label="Dark mode switcher" id="appearance-switcher-mobile" style="margin-right:5px" type="button">
<div class="flex items-center justify-center h-12 dark:hidden">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M32 256c0-123.8 100.3-224 223.8-224c11.36 0 29.7 1.668 40.9 3.746c9.616 1.777 11.75 14.63 3.279 19.44C245 86.5 211.2 144.6 211.2 207.8c0 109.7 99.71 193 208.3 172.3c9.561-1.805 16.28 9.324 10.11 16.95C387.9 448.6 324.8 480 255.8 480C132.1 480 32 379.6 32 256z" fill="currentColor"></path></svg>
</span>
</div>
<div class="items-center justify-center hidden h-12 dark:flex">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M256 159.1c-53.02 0-95.1 42.98-95.1 95.1S202.1 351.1 256 351.1s95.1-42.98 95.1-95.1S309 159.1 256 159.1zM509.3 347L446.1 255.1l63.15-91.01c6.332-9.125 1.104-21.74-9.826-23.72l-109-19.7l-19.7-109c-1.975-10.93-14.59-16.16-23.72-9.824L256 65.89L164.1 2.736c-9.125-6.332-21.74-1.107-23.72 9.824L121.6 121.6L12.56 141.3C1.633 143.2-3.596 155.9 2.736 164.1L65.89 256l-63.15 91.01c-6.332 9.125-1.105 21.74 9.824 23.72l109 19.7l19.7 109c1.975 10.93 14.59 16.16 23.72 9.824L256 446.1l91.01 63.15c9.127 6.334 21.75 1.107 23.72-9.822l19.7-109l109-19.7C510.4 368.8 515.6 356.1 509.3 347zM256 383.1c-70.69 0-127.1-57.31-127.1-127.1c0-70.69 57.31-127.1 127.1-127.1s127.1 57.3 127.1 127.1C383.1 326.7 326.7 383.1 256 383.1z" fill="currentColor"></path></svg>
</span>
</div>
</button>
</div>
</div>
<div class="-my-2 -mr-2 md:hidden">
<label class="block" for="menu-controller" id="menu-button">
<input class="hidden" id="menu-controller" type="checkbox"/>
<div class="cursor-pointer hover:text-primary-600 dark:hover:text-primary-400">
<span class="relative block icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M0 96C0 78.33 14.33 64 32 64H416C433.7 64 448 78.33 448 96C448 113.7 433.7 128 416 128H32C14.33 128 0 113.7 0 96zM0 256C0 238.3 14.33 224 32 224H416C433.7 224 448 238.3 448 256C448 273.7 433.7 288 416 288H32C14.33 288 0 273.7 0 256zM416 448H32C14.33 448 0 433.7 0 416C0 398.3 14.33 384 32 384H416C433.7 384 448 398.3 448 416C448 433.7 433.7 448 416 448z" fill="currentColor"></path></svg>
</span>
</div>
<div class="fixed inset-0 z-30 invisible w-screen h-screen m-auto overflow-auto transition-opacity opacity-0 cursor-default bg-neutral-100/50 backdrop-blur-sm dark:bg-neutral-900/50" id="menu-wrapper" style="padding-top:5px;">
<ul class="flex space-y-2 mt-3 flex-col items-end w-full px-6 py-6 mx-auto overflow-visible list-none ltr:text-right rtl:text-left max-w-7xl">
<li>
<span class="cursor-pointer inline-block align-text-bottom hover:text-primary-600 dark:hover:text-primary-400">
<span class="relative block icon">
<svg viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z" fill="currentColor"></path></svg>
</span>
</span>
</li>
<li class="mt-1">
<a class="flex items-center" href="/posts/">
<p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Posts">
            Posts
        </p>
</a>
</li>
<li class="mt-1">
<a class="flex items-center" href="/categories/">
<p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Categories">
            分类
        </p>
</a>
</li>
<li class="mt-1">
<a class="flex items-center" href="/tags/">
<p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="Tags">
            标签
        </p>
</a>
</li>
<li class="mt-1">
<a class="flex items-center" href="/link/">
<p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="友链/links">
            友链
        </p>
</a>
</li>
<li class="mt-1">
<a class="flex items-center" href="/about/">
<p class="text-bg font-bg text-gray-500 hover:text-gray-900" title="About">
            About
        </p>
</a>
</li>
</ul>
</div>
</label>
</div>
</div>
<script>
    (function () {
        var $mainmenu = $('.main-menu');
        var path = window.location.pathname;
        $mainmenu.find('a[href="' + path + '"]').each(function (i, e) {
            $(e).children('p').addClass('active');
        });
    })();
</script>
</div>
</div>
<script>
  window.addEventListener('scroll', function (e) {
    var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
    var background_blur = document.getElementById('menu-blur');
    background_blur.style.opacity = (scroll / 300);
  });
</script>
<div class="relative flex flex-col grow">
<main class="grow" id="main-content">
<article>
<div class="h-[150px] md:h-[200px]" id="hero"></div>
<div class="fixed inset-x-0 top-0 h-[800px] single_hero_background nozoom" style="background-image:url(/posts/pwn/heap/chunk_1/featured.png);">
<div class="absolute inset-0 bg-gradient-to-t from-neutral dark:from-neutral-800 to-transparent mix-blend-normal">
</div>
<div class="absolute inset-0 opacity-60 bg-gradient-to-t from-neutral dark:from-neutral-800 to-neutral-100 dark:to-neutral-800 mix-blend-normal">
</div>
</div>
<div class="fixed opacity-0 inset-x-0 top-0 h-full single_hero_background nozoom backdrop-blur-2xl" id="background-blur"></div>
<script>
    window.addEventListener('scroll', function (e) {
        var scroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop || 0;
        var background_blur = document.getElementById('background-blur');
        background_blur.style.opacity = (scroll / 300)
    });
</script>
<header class="mt-5 max-w-prose" id="single_header">
<ol class="text-sm text-neutral-500 dark:text-neutral-400 print:hidden">
<li class="inline hidden">
<a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/"></a><span class="px-1 text-primary-500">/</span>
</li>
<li class="inline">
<a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/">Posts</a><span class="px-1 text-primary-500">/</span>
</li>
<li class="inline hidden">
<a class="hover:underline decoration-neutral-300 dark:underline-neutral-600" href="/posts/pwn/heap/chunk_1/">堆基础知识学习记录</a><span class="px-1 text-primary-500">/</span>
</li>
</ol>
<h1 class="mt-0 text-4xl font-extrabold text-neutral-900 dark:text-neutral">
      堆基础知识学习记录
    </h1>
<div class="mt-1 mb-6 text-base text-neutral-500 dark:text-neutral-400 print:hidden">
<div class="flex flex-row flex-wrap items-center">
<time datetime="2023-07-31 00:00:00 +0000 UTC">July 31, 2023</time><span class="px-2 text-primary-500">·</span><span>9063 字</span><span class="px-2 text-primary-500">·</span><span title="预计阅读">19 分钟</span>
</div>
<div class="flex flex-row flex-wrap items-center">
<span class="mr-2" onclick="window.open(&quot;/categories/pwn%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN学习记录
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/ctf/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CTF
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/pwn/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/heap/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    heap
  </span>
</span>
</span>
</div>
</div>
<div class="flex">
<div class="place-self-center">
<div class="text-[0.6rem] uppercase leading-3 text-neutral-500 dark:text-neutral-400">
      作者
    </div>
<div class="font-semibold leading-6 text-neutral-800 dark:text-neutral-300">
      ta0lve
    </div>
<div class="text-sm text-neutral-700 dark:text-neutral-400">一些记录，一点思考</div>
<div class="text-2xl sm:text-lg">
<div class="flex flex-wrap text-neutral-400 dark:text-neutral-500">
<a aria-label="Email" class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href="mailto:hujt25@mail2.sysu.edu.cn" rel="me noopener noreferrer" target="_blank"><span class="inline-block align-text-bottom">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M207.8 20.73c-93.45 18.32-168.7 93.66-187 187.1c-27.64 140.9 68.65 266.2 199.1 285.1c19.01 2.888 36.17-12.26 36.17-31.49l.0001-.6631c0-15.74-11.44-28.88-26.84-31.24c-84.35-12.98-149.2-86.13-149.2-174.2c0-102.9 88.61-185.5 193.4-175.4c91.54 8.869 158.6 91.25 158.6 183.2l0 16.16c0 22.09-17.94 40.05-40 40.05s-40.01-17.96-40.01-40.05v-120.1c0-8.847-7.161-16.02-16.01-16.02l-31.98 .0036c-7.299 0-13.2 4.992-15.12 11.68c-24.85-12.15-54.24-16.38-86.06-5.106c-38.75 13.73-68.12 48.91-73.72 89.64c-9.483 69.01 43.81 128 110.9 128c26.44 0 50.43-9.544 69.59-24.88c24 31.3 65.23 48.69 109.4 37.49C465.2 369.3 496 324.1 495.1 277.2V256.3C495.1 107.1 361.2-9.332 207.8 20.73zM239.1 304.3c-26.47 0-48-21.56-48-48.05s21.53-48.05 48-48.05s48 21.56 48 48.05S266.5 304.3 239.1 304.3z" fill="currentColor"></path></svg>
</span>
</span></a>
<a aria-label="Blogger" class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href="https://ta0lve.github.io/" rel="me noopener noreferrer" target="_blank"><span class="inline-block align-text-bottom">
<span class="relative block icon">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><path d="M446.6 222.7c-1.8-8-6.8-15.4-12.5-18.5-1.8-1-13-2.2-25-2.7-20.1-.9-22.3-1.3-28.7-5-10.1-5.9-12.8-12.3-12.9-29.5-.1-33-13.8-63.7-40.9-91.3-19.3-19.7-40.9-33-65.5-40.5-5.9-1.8-19.1-2.4-63.3-2.9-69.4-.8-84.8.6-108.4 10C45.9 59.5 14.7 96.1 3.3 142.9 1.2 151.7.7 165.8.2 246.8c-.6 101.5.1 116.4 6.4 136.5 15.6 49.6 59.9 86.3 104.4 94.3 14.8 2.7 197.3 3.3 216 .8 32.5-4.4 58-17.5 81.9-41.9 17.3-17.7 28.1-36.8 35.2-62.1 4.9-17.6 4.5-142.8 2.5-151.7zm-322.1-63.6c7.8-7.9 10-8.2 58.8-8.2 43.9 0 45.4.1 51.8 3.4 9.3 4.7 13.4 11.3 13.4 21.9 0 9.5-3.8 16.2-12.3 21.6-4.6 2.9-7.3 3.1-50.3 3.3-26.5.2-47.7-.4-50.8-1.2-16.6-4.7-22.8-28.5-10.6-40.8zm191.8 199.8l-14.9 2.4-77.5.9c-68.1.8-87.3-.4-90.9-2-7.1-3.1-13.8-11.7-14.9-19.4-1.1-7.3 2.6-17.3 8.2-22.4 7.1-6.4 10.2-6.6 97.3-6.7 89.6-.1 89.1-.1 97.6 7.8 12.1 11.3 9.5 31.2-4.9 39.4z" fill="currentColor"></path></svg>
</span>
</span></a>
<a aria-label="Github" class="px-1 hover:text-primary-700 dark:hover:text-primary-400" href="https://github.com/ta0lve" rel="me noopener noreferrer" target="_blank"><span class="inline-block align-text-bottom">
<span class="relative block icon">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z" fill="currentColor"></path></svg>
</span>
</span></a>
</div>
</div>
</div>
</div>
<div class="mb-5"></div>
</header>
<section class="flex flex-col max-w-full mt-0 prose dark:prose-invert lg:flex-row">
<div class="order-first sm:max-w-prose lg:ml-auto px-0 lg:order-last lg:max-w-xs ltr:lg:pl-8 rtl:lg:pr-8">
<div class="toc ltr:pl-5 rtl:pr-5 print:hidden lg:sticky lg:top-10">
<details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 hidden lg:block" open="">
<summary class="block py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
</summary>
<div class="min-w-[220px] py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
<nav id="TableOfContents">
<ul>
<li><a href="#堆的概念">堆的概念</a></li>
<li><a href="#堆的实现">堆的实现</a></li>
<li><a href="#堆的微观结构">堆的微观结构</a>
<ul>
<li><a href="#size_sz-与-size_t"><strong>SIZE_SZ 与 size_t</strong></a></li>
<li><a href="#chunk"><strong>chunk</strong></a></li>
<li><a href="#prev_size"><strong>prev_size</strong></a></li>
<li><a href="#size"><strong>size</strong></a>
<ul>
<li><a href="#一些基础的攻击思路">一些基础的攻击思路：</a></li>
</ul>
</li>
<li><a href="#fdbk"><strong>fd，bk</strong></a></li>
<li><a href="#fd_nextsize-bk_nextsize"><strong>fd_nextsize， bk_nextsize</strong></a></li>
<li><a href="#一些细节">一些细节</a></li>
</ul>
</li>
<li><a href="#堆的宏观结构">堆的宏观结构</a>
<ul>
<li><a href="#arena--main_arena"><strong>arena &amp; main_arena</strong></a></li>
<li><a href="#malloc_state"><strong>malloc_state</strong></a></li>
<li><a href="#bin"><strong>bin</strong></a>
<ul>
<li><a href="#fastbin"><strong>fastbin</strong></a></li>
<li><a href="#unsortedbin"><strong>unsortedbin</strong></a></li>
<li><a href="#smallbin"><strong>smallbin</strong></a></li>
<li><a href="#largebin"><strong>largebin</strong></a></li>
</ul>
</li>
<li><a href="#top-chunk"><strong>top chunk</strong></a></li>
<li><a href="#附录">附录</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</details>
<details class="mt-0 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 lg:hidden">
<summary class="py-1 text-lg font-semibold cursor-pointer bg-neutral-100 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-neutral-700 dark:text-neutral-100 lg:hidden">
</summary>
<div class="py-2 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
<nav id="TableOfContents">
<ul>
<li><a href="#堆的概念">堆的概念</a></li>
<li><a href="#堆的实现">堆的实现</a></li>
<li><a href="#堆的微观结构">堆的微观结构</a>
<ul>
<li><a href="#size_sz-与-size_t"><strong>SIZE_SZ 与 size_t</strong></a></li>
<li><a href="#chunk"><strong>chunk</strong></a></li>
<li><a href="#prev_size"><strong>prev_size</strong></a></li>
<li><a href="#size"><strong>size</strong></a>
<ul>
<li><a href="#一些基础的攻击思路">一些基础的攻击思路：</a></li>
</ul>
</li>
<li><a href="#fdbk"><strong>fd，bk</strong></a></li>
<li><a href="#fd_nextsize-bk_nextsize"><strong>fd_nextsize， bk_nextsize</strong></a></li>
<li><a href="#一些细节">一些细节</a></li>
</ul>
</li>
<li><a href="#堆的宏观结构">堆的宏观结构</a>
<ul>
<li><a href="#arena--main_arena"><strong>arena &amp; main_arena</strong></a></li>
<li><a href="#malloc_state"><strong>malloc_state</strong></a></li>
<li><a href="#bin"><strong>bin</strong></a>
<ul>
<li><a href="#fastbin"><strong>fastbin</strong></a></li>
<li><a href="#unsortedbin"><strong>unsortedbin</strong></a></li>
<li><a href="#smallbin"><strong>smallbin</strong></a></li>
<li><a href="#largebin"><strong>largebin</strong></a></li>
</ul>
</li>
<li><a href="#top-chunk"><strong>top chunk</strong></a></li>
<li><a href="#附录">附录</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</details>
<script>
  (function () {
    var $toc = $('#TableOfContents');
    if ($toc.length > 0) {
      var $window = $(window);

      function onScroll() {
        var currentScroll = $window.scrollTop();
        var h = $('.anchor');
        var id = "";
        h.each(function (i, e) {
          e = $(e);
          if (e.offset().top - $(window).height()/3 <= currentScroll) {
            id = e.attr('id');
          }
        });
        var active = $toc.find('a.active');      
        if (active.length == 1 && active.eq(0).attr('href') == '#' + id) return true;

        active.each(function (i, e) {
          
            $(e).removeClass('active');
          
        });
        $toc.find('a[href="#' + id + '"]').addClass('active')
        $toc.find('a[href="#' + id + '"]').parentsUntil('#TableOfContents').each(function (i, e) {
          $(e).children('a').parents('ul').show();          
        });
      }

      $window.on('scroll', onScroll);
      $(document).ready(function () {
        
        onScroll();
      });
    }
  })();
</script>
</div>
</div>
<div class="min-w-0 min-h-0 max-w-prose">
<details class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" open="" style="margin-left:0px">
<summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        堆学习记录 - This article is part of a series.
    </summary>
<div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 1: This Article
    </div>
</details>
<div class="flex px-4 py-3 rounded-md bg-primary-100 dark:bg-primary-900">
<span class="text-primary-400 ltr:pr-3 rtl:pl-3 flex items-center">
<span class="relative block icon">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M506.3 417l-213.3-364c-16.33-28-57.54-28-73.98 0l-213.2 364C-10.59 444.9 9.849 480 42.74 480h426.6C502.1 480 522.6 445 506.3 417zM232 168c0-13.25 10.75-24 24-24S280 154.8 280 168v128c0 13.25-10.75 24-23.1 24S232 309.3 232 296V168zM256 416c-17.36 0-31.44-14.08-31.44-31.44c0-17.36 14.07-31.44 31.44-31.44s31.44 14.08 31.44 31.44C287.4 401.9 273.4 416 256 416z" fill="currentColor"></path></svg>
</span>
</span>
<span class="dark:text-neutral-300"><strong>如果本博客部分文章图片加载失败，</strong><a href="https://ta0lve.github.io/posts/sth/sm.ms/" target="_blank">
<strong>可以点击此处查看解决办法</strong></a></span>
</div>
<div class="anchor" id="堆的概念"></div>
<h2 class="relative group">堆的概念 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e5%a0%86%e7%9a%84%e6%a6%82%e5%bf%b5" style="text-decoration-line: none !important;">#</a></span>
</h2>
<p>在程序运行过程中，堆可以提供动态分配的内存，允许程序申请大小未知的内存。堆其实就是程序虚拟地址空间的一块<strong>连续的线性区域</strong>，它<strong>由低地址向高地址</strong>方向增长。我们一般称管理堆的那部分程序为堆管理器。（from <a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-overview/" target="_blank">
    wiki</a>）</p>
<div class="anchor" id="堆的实现"></div>
<h2 class="relative group">堆的实现 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e5%a0%86%e7%9a%84%e5%ae%9e%e7%8e%b0" style="text-decoration-line: none !important;">#</a></span>
</h2>
<ul>
<li>
<p>dlmalloc : Genral purpose allocator</p>
</li>
<li>
<p>jemalloc : Freebsd and Firefox</p>
</li>
<li>
<p>tcmalloc : Google</p>
</li>
<li>
<p>libumen : Solaris</p>
</li>
<li>
<p><strong>ptmalloc2 : glibc</strong></p>
<ul>
<li>
<p>堆的实现以ptmalloc2中堆的实现为主</p>
</li>
<li>
<p>在 glibc-2.3.x. 之后，glibc 中集成了ptmalloc2，可以<a href="http://ftp.gnu.org/gnu/glibc/" target="_blank">
     下载glibc源码 </a> 查看ptmalloc</p>
</li>
<li>
<p><a href="http://ftp.gnu.org/gnu/glibc/" target="_blank">
    Index of /gnu/glibc</a></p>
</li>
<li>
<p>查看glibc版本</p>
<ul>
<li>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="c1"># shell:</span>
</span></span><span class="line"><span class="cl">ldd --version
</span></span><span class="line"><span class="cl"><span class="c1"># 输出：</span>
</span></span><span class="line"><span class="cl">ldd <span class="o">(</span>Ubuntu GLIBC 2.35-0ubuntu3.1<span class="o">)</span> 2.35
</span></span></code></pre></div></li>
<li>
<p>
<figure>
<img alt="image-20230801184545837" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/01/JIksTPOrmlAKVNQ.png"/>
</figure>
</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>glibc内存管理流程图（看不清楚可以保存下来放大）：</p>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/WsrFx6btKpVe2DP.png"/>
</figure>
</p>
<br/>
<p>glibc运行时库分配动态内存，底层用的是malloc来实现(new 最终也是调用malloc)，下面是malloc函数调用流程图：</p>
<p>
<figure>
<img alt="image-20230830005928014" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/p3W5cNCbhYKts78.png"/>
</figure>
</p>
<hr/>
<p><strong>堆管理器</strong></p>
<p>堆管理器位于程序与内核之间，主要做两件事：</p>
<ul>
<li>响应用户申请内存的请求 （<strong>请求堆</strong>）
<ul>
<li>为了保持内存管理的高效性，内核一般都会预先分配很大的一块连续的内存（虚拟内存），即 <strong>top _chunk</strong>
<ul>
<li>只有当真正访问一个地址的时候，系统才会在虚拟内存和物理页面的映射关系。</li>
<li>所以这里的内存其实只是虚拟内存。只有当用户使用到相应的内存时，系统才会真正分配物理内存给用户使用。</li>
</ul>
</li>
<li>只有当出现了堆空间不足的情况，堆管理器才会再次与操作系统进行交互
<ul>
<li>新创建一个<strong>top_chunk</strong>，并且把原来的<strong>top_chunk</strong>分配到<strong>unsorted_bin</strong> 里面</li>
</ul>
</li>
</ul>
</li>
<li>管理用户所释放的内存 （<strong>释放堆</strong>）
<ul>
<li>用户释放的内存并不是直接返还给操作系统，而是由堆管理器进行管理，除了<strong>fastbin</strong>以外大都由<strong>bins</strong>来管理</li>
<li>这些释放的内存可以用来响应用户新申请的内存的请求。</li>
</ul>
</li>
</ul>
<hr/>
<p><strong>系统所调用的函数</strong></p>
<p>malloc和free在动态申请或释放内存时，主要是调用(s)brk和mmap,unmmap函数实现的。</p>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/ETkLOdiNJHCMagr.png"/>
</figure>
</p>
<ol>
<li><strong>(s)brk函数</strong>机制</li>
</ol>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp"># include &lt;stdio.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"># include &lt;unistd.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"># include &lt;sys/types.h&gt;
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="kt">void</span> <span class="o">*</span><span class="n">cuur_bkr</span><span class="p">,</span><span class="o">*</span><span class="n">tmp_brk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">"%d</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">getid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"> <span class="n">tm_brk</span> <span class="o">=</span> <span class="n">curr_brk</span> <span class="o">=</span> <span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//给当前程序一个brk
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">curr_brk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="n">brk</span><span class="p">(</span><span class="n">curr_brk</span><span class="o">+</span><span class="mi">4096</span><span class="p">);</span> <span class="c1">//设置结尾位置,即分配了4096字节的堆块
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="n">curr_brk</span><span class="o">=</span><span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">curr_brk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="n">brk</span><span class="p">(</span><span class="n">tmp_brk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">curr_brk</span><span class="o">=</span><span class="n">sbrk</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">printf</span><span class="p">(</span><span class="s">"%p</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span><span class="n">curr_brk</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"> <span class="n">getchar</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><ul>
<li>
<p>用于设置program_break指向的位置</p>
</li>
<li>
<p>sbrk()函数</p>
<ul>
<li>同brk()，参数可以是负数。执行成功返回上一次program_break的值，可以设置参数为0返回当前的program_break</li>
</ul>
</li>
<li>
<p>初始时，堆的起始地址start_brk以及堆的当前末尾brk指向同一地址。根据是否开启ASLR，两者的具体位置会有所不同</p>
<ul>
<li>
<p>开启ASLR后，BSS segment和heap间存在Random brk offset</p>
</li>
<li>
<p>关闭ASLR后，堆开始地址和数据段结束地址重合</p>
<ul>
<li>不开启ASLR时，start_brk以及brk会指向data/bss段的结尾</li>
</ul>
</li>
<li>
<p>sbrk创建的chunk紧邻数据段</p>
</li>
</ul>
</li>
</ul>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/VL38AkEzl1qBaWe.png"/>
</figure>
</p>
<br/>
<ol start="2">
<li><strong>mmap函数</strong>机制</li>
</ol>
<ul>
<li>当用户申请空间大于等于128kb，也就是0x20000字节时，不再使用brk()进行分配，改为使用mmap()</li>
<li>malloc会使用mmap来创建独立的匿名映射段。</li>
<li>匿名映射的目的主要是可以申请以0填充的内存，并且这块内存仅被调用进程所使用，这块内存为系统随机分配。</li>
<li>munmap用于释放内存。</li>
<li>mmap创建的chunk紧邻libc</li>
<li>unmmap()函数将mmap()申请的空间进行回收</li>
</ul>
<hr/>
<p><strong>多线程支持</strong></p>
<ul>
<li>在原来的dlmalloc实现中，当两个线程同时要申请内存时，只有一个线程可以进入临界区申请内存，而另外一个线程必须等待直到临界区中不再有线程。</li>
<li>这是因为所有的线程共享一个堆。</li>
<li>在glibc和ptmalloc实现中，支持了多线程的快速访问，在新的实现中，所有的线程共享多个堆。</li>
</ul>
<p>详见 <a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-overview/#_5" target="_blank">
    wiki</a></p>
<hr/>
<div class="anchor" id="堆的微观结构"></div>
<h2 class="relative group">堆的微观结构 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e5%a0%86%e7%9a%84%e5%be%ae%e8%a7%82%e7%bb%93%e6%9e%84" style="text-decoration-line: none !important;">#</a></span>
</h2>
<p>先补充两句，个人认为从总体上看可以把堆的数据结构分为微观结构和宏观结构：</p>
<ul>
<li>微观结构主要是<strong>malloc_chunk</strong>的数据与结构：
<ul>
<li>prev_size</li>
<li>size</li>
<li>fd，bk</li>
<li>fd_nextsize， bk_nextsize</li>
</ul>
</li>
<li>宏观结构包括堆块的宏观信息，可以使我们更好地了解glibc的堆管理实现，宏观结构分为以下几个部分：
<ul>
<li><strong>arena &amp; main_arena</strong>：可以看作是堆块的管理器，但其实就是<strong>堆内存本身</strong></li>
<li><strong>bin</strong>：用<strong>链表结构</strong>管理被free的malloc_chunk（堆块）</li>
<li><strong>top_chunk</strong>：处于一个arena的最顶部(即最高内存地址处)、不属于任何<strong>bin</strong>的一片内存</li>
<li><strong>malloc_state</strong>：管理 arena 的核心结构，包含堆的状态信息、bins 链表等
<ul>
<li>main arena 对应的 malloc state 结构存储在 glibc 全局变量中</li>
<li>其他线程 arena 对应的 malloc_state 存储在 arena 本身中</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<div class="anchor" id="size_sz-与-size_t"></div>
<h3 class="relative group"><strong>SIZE_SZ 与 size_t</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#size_sz-%e4%b8%8e-size_t" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>先补充一个小知识，关于堆中结构我们常常会看到<strong>SIZE_SZ</strong> 与 <strong>size_t</strong>，但实际上，在一般场景里他们两个的值是一样的，即在32位系统中是8字节，在64位系统中是16字节。</p>
<p>下载glibc源码查看ptmalloc可以看到：</p>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="cp">#ifndef INTERNAL_SIZE_T
</span></span></span><span class="line"><span class="cl"><span class="cp">#define INTERNAL_SIZE_T size_t
</span></span></span><span class="line"><span class="cl"><span class="cp">#endif
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="cm">/* The corresponding word size. */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define SIZE_SZ (sizeof (INTERNAL_SIZE_T))
</span></span></span></code></pre></div><ul>
<li>INTERNAL_SIZE_T：size_t，为32/64位整数（8字节/16字节）</li>
<li>SIZE_SZ：同size_t，8字节/16字节</li>
</ul>
<hr/>
<div class="anchor" id="chunk"></div>
<h3 class="relative group"><strong>chunk</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#chunk" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p><strong>chunk是glibc管理内存的基本单元。主要分为以下几类：</strong></p>
<ul>
<li>alloced chunk：已分配正在使用中的chunk。</li>
<li>free chunk：已经free的chunk。</li>
<li>top chunk：可以理解为地址的最高处，还没有分配的chunk。</li>
<li>last remainder chunk：是为了提高内存分配的局部性。</li>
</ul>
<p>chunk = chunk header + user data，malloc返回给用户的其实是<strong>user data指针</strong>，具体如下图：</p>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/WeI5ZNlhgqtGcUJ.png"/>
</figure>
</p>
<p>malloc_chunk的结构如下：</p>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-cpp" data-lang="cpp"><span class="line"><span class="cl"><span class="k">struct</span> <span class="nc">malloc_chunk</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">prev_size</span><span class="p">;</span>  <span class="cm">/* 如果前面一个堆块是空闲的则表示前一个堆块的大小,否则无意义  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">INTERNAL_SIZE_T</span>      <span class="n">size</span><span class="p">;</span>       <span class="cm">/* 当前chunk的大小，由于对齐的原因所以低三位作为标志位*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*######################
</span></span></span><span class="line"><span class="cl"><span class="cm"> 1.真正的内存从这里开始分配
</span></span></span><span class="line"><span class="cl"><span class="cm"> 2.malloc之后这些指针没有用,这时存放的是数据
</span></span></span><span class="line"><span class="cl"><span class="cm"> 3.只有在free之后才有效。
</span></span></span><span class="line"><span class="cl"><span class="cm">########################*/</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">malloc_chunk</span><span class="o">*</span> <span class="n">fd</span><span class="p">;</span> <span class="cm">/* 当chunk空闲时才有意义,记录后一个空闲chunk的地址 */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">malloc_chunk</span><span class="o">*</span> <span class="n">bk</span><span class="p">;</span> <span class="cm">/* 同上,记录前一个空闲chunk的地址  */</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">  <span class="cm">/* Only used for large blocks: pointer to next larger size. */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">malloc_chunk</span><span class="o">*</span> <span class="n">fd_nextsize</span><span class="p">;</span> <span class="cm">/*当前chunk为largebin时才有意义，指向下一个与当前chunk大小不同的第一个空闲块*/</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="nc">malloc_chunk</span><span class="o">*</span> <span class="n">bk_nextsize</span><span class="p">;</span><span class="cm">/*指向上一个与当前chunk大小不同的第一个空闲块*/</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>每个字段的具体的解释如下（from <a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-structure/" target="_blank">
    wiki</a> and <a href="https://zhuanlan.zhihu.com/p/77316206" target="_blank">
    zhihu</a>）</p>
<br/>
<hr/>
<div class="anchor" id="prev_size"></div>
<h3 class="relative group"><strong>prev_size</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#prev_size" style="text-decoration-line: none !important;">#</a></span>
</h3>
<ul>
<li>如果该 chunk 的<strong>物理相邻</strong>的前一地址 <strong>chunk</strong>（两个指针的地址差值为前一 chunk 大小）是空闲的话，那该字段记录的是前一个 chunk 的大小 (包括 chunk 头)。</li>
<li>否则，该字段可以用来存储物理相邻的前一个 chunk 的数据。<strong>这里的前一 chunk 指的是较低地址的 chunk</strong> 。
<ul>
<li>当申请的内存大小对 2*SIZE_SZ 取余之后小于等于 size_t 的话就可以用它的下一个 chunk 的 prev_size</li>
<li>比如：64位下 malloc(0x55)， 0x58 mod 0x10 还差 0x8 &lt;= 0x8字节，那他就可以用后面一个 chunk 的 prev_size，最后加上 chunk header 大小是 0x60（所以下图为6行）</li>
<li>还是 64 位下，如果大小是 0x59 的话 mod 0x10之后还差 0x9 &gt; 0x8字节，那就不够用了，只能多申请一块，最后加上 chunk header 用了 0x70（所以下图为7行）</li>
<li>
<figure>
<img alt="image-20230807000723376.png" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/07/7EtxpCK6egOlbHT.png"/>
</figure>
</li>
</ul>
</li>
<li>malloc(0x58)会分配0x60的内存</li>
<li>malloc(0x59)会分配0x70的内存</li>
</ul>
<hr/>
<div class="anchor" id="size"></div>
<h3 class="relative group"><strong>size</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#size" style="text-decoration-line: none !important;">#</a></span>
</h3>
<ul>
<li>该 chunk 的大小，大小必须是 2 * SIZE_SZ 的整数倍。
<ul>
<li>SIZE_SZ 在32位系统下是 32位 即4个字节大小，在64位系统下是 64位 即8个字节大小</li>
<li>所以64位chunk的size必须是16字节对齐，32位chunk的size必须是8 字节对齐</li>
<li>64位 低4位没用 11110000</li>
<li>32位 低3位没用 11111000</li>
<li><strong>关于16字节对齐：</strong></li>
<li>1字节为8位，即2个16进制位（如 <strong>0xff</strong> ），所以16字节为32个16进制位</li>
<li>在gdb中体现为 <strong>0x0011223344556677  0x8899aabbccddeeff</strong> 为16字节</li>
</ul>
</li>
<li>NON_MAIN_ARENA，<strong>A</strong>：倒数第三位表示当前chunk属于主分配区(0)还是非主分配区(1)</li>
<li>IS_MAPPED，<strong>M</strong>：倒数第二位表示当前chunk是从mmap(1)[多线程]分配的，还是从brk(0)[子线程]分配的</li>
<li>PREV_INUSE， <strong>P</strong>：最低位表示前一个 chunk 块是否被分配。
<ul>
<li>一般来说，堆中第一个被分配的内存块的 size 字段的 P 位都会被设置为 1，以便于防止访问前面的非法内存。</li>
<li>当一个 chunk 的 size 的 P 位为 0 时，我们能通过 prev_size 字段来获取上一个 chunk 的大小以及地址。这也方便进行空闲 chunk 之间的合并。</li>
<li>对于<strong>fastbin</strong>的堆块,不管前面还有没有被分配的chunk，<strong>P</strong>位都为1 。</li>
</ul>
</li>
</ul>
<div class="anchor" id="一些基础的攻击思路"></div>
<h4 class="relative group">一些基础的攻击思路： 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e4%b8%80%e4%ba%9b%e5%9f%ba%e7%a1%80%e7%9a%84%e6%94%bb%e5%87%bb%e6%80%9d%e8%b7%af" style="text-decoration-line: none !important;">#</a></span>
</h4>
<ul>
<li>chunk1的数据有效区域覆盖到chunk2的prev_size位,并且chunk2的size位的prev_inuse被覆盖为0。系统认为chunk2之前的chunk1已经未在使用了。</li>
<li>当free(chunk2)的时候,系统会将chunk2与chunk2中prev_size大小的空间合并到bins。</li>
<li>我们可以通过改变chunk2的prev_size的内容,操纵向前合并的大小。</li>
<li>造成的问题：overlap(堆块重叠)，chunk1被释放了，但是我们可以操纵修改它(堆利用的核心思想)，从而修改bins链的内容，泄露其中的地址。</li>
<li>形成的攻击：fastbin —&gt; fd —&gt; main_arena —&gt; 分配新的堆块，我们通过修改chunk1的fd内容，达到分配任意内存的目的，造成<strong>fastbin attack</strong>。</li>
<li><strong>最小堆原则</strong> : malloc(0)会分配0x20的空间,prev_size + size + 数据对齐的0x10字节</li>
</ul>
<hr/>
<div class="anchor" id="fdbk"></div>
<h3 class="relative group"><strong>fd，bk</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#fdbk" style="text-decoration-line: none !important;">#</a></span>
</h3>
<ul>
<li>
<p>chunk 处于分配状态时，从 fd 字段开始是用户的数据。chunk 空闲时，会被添加到对应的空闲管理链表中，其字段的含义如下</p>
</li>
<li>
<p>fd（forward） 指向前一个（非物理相邻）空闲的 chunk</p>
<ul>
<li>如在fastbin中指向的是上一个被释放的chunk</li>
</ul>
</li>
<li>
<p>bk （backward）指向后一个（非物理相邻）空闲的 chunk</p>
</li>
<li>
<p>通过 fd 和 bk 可以将空闲的 chunk 块加入到空闲的 chunk 块链表进行统一管理</p>
</li>
</ul>
<hr/>
<div class="anchor" id="fd_nextsize-bk_nextsize"></div>
<h3 class="relative group"><strong>fd_nextsize， bk_nextsize</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#fd_nextsize-bk_nextsize" style="text-decoration-line: none !important;">#</a></span>
</h3>
<ul>
<li>也是只有 chunk 空闲的时候才使用，不过其用于较大的 chunk（large chunk）。</li>
<li>fd_nextsize 指向前一个与当前 chunk 大小不同的第一个空闲块，不包含 bin 的头指针。</li>
<li>bk_nextsize 指向后一个与当前 chunk 大小不同的第一个空闲块，不包含 bin 的头指针。</li>
<li>一般空闲的 large chunk 在 fd 的遍历顺序中，按照由大到小的顺序排列。<strong>这样做可以避免在寻找合适 chunk 时挨个遍历。</strong></li>
</ul>
<hr/>
<div class="anchor" id="一些细节"></div>
<h3 class="relative group">一些细节 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e4%b8%80%e4%ba%9b%e7%bb%86%e8%8a%82" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>一个已经分配的 chunk 的样子如下。我们称前两个字段称为 <strong>chunk header</strong>，后面的部分称为 <strong>user data</strong>。每次 malloc 申请得到的内存指针，其实指向 user data 的起始处。</p>
<p>当一个 chunk 处于使用状态时，它的下一个 chunk 的 prev_size 域无效，所以下一个 chunk 的该部分也可以被当前 chunk 使用。这就是 chunk 中的<strong>空间复用</strong>。</p>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 使用中的chunk结构</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">previous</span> <span class="n">chunk</span><span class="p">,</span> <span class="k">if</span> <span class="n">unallocated</span> <span class="p">(</span><span class="n">P</span> <span class="n">clear</span><span class="p">)</span>  <span class="o">|</span> <span class="c1"># 前一个堆未被使用时可以知道其大小</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">bytes</span>                     <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="n">M</span><span class="o">|</span><span class="n">P</span><span class="o">|</span> <span class="c1"># 重点在P位</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">User</span> <span class="n">data</span> <span class="n">starts</span> <span class="n">here</span><span class="o">...</span>                          <span class="o">.</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span>                                                               <span class="o">.</span> <span class="c1"># 没有fd和bk指针</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span>             <span class="p">(</span><span class="n">malloc_usable_size</span><span class="p">()</span> <span class="nb">bytes</span><span class="p">)</span>                      <span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="nb">next</span>    <span class="o">.</span>                                                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="p">(</span><span class="n">size</span> <span class="n">of</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">but</span> <span class="n">used</span> <span class="k">for</span> <span class="n">application</span> <span class="n">data</span><span class="p">)</span>    <span class="o">|</span> <span class="c1"># 由于本chunk正在使用，</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span> <span class="c1"># 所以占用了下一个chunk的prev_size位</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="nb">next</span> <span class="n">chunk</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">bytes</span>                <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="mi">1</span><span class="o">|</span> <span class="c1"># 下一个chunk的size位</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl"><span class="c1"># 未使用的chunk结构</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="n">previous</span> <span class="n">chunk</span><span class="p">,</span> <span class="k">if</span> <span class="n">unallocated</span> <span class="p">(</span><span class="n">P</span> <span class="n">clear</span><span class="p">)</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl"><span class="err">`</span><span class="n">head</span><span class="p">:</span><span class="s1">' |             Size of chunk, in bytes                     |A|0|P|</span>
</span></span><span class="line"><span class="cl">  <span class="n">mem</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Forward</span> <span class="n">pointer</span> <span class="n">to</span> <span class="nb">next</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">list</span>             <span class="o">|</span> <span class="c1"># fd指针(指向chunk链表的前一个空闲块)</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Back</span> <span class="n">pointer</span> <span class="n">to</span> <span class="n">previous</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">list</span>            <span class="o">|</span> <span class="c1"># bk指针</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Unused</span> <span class="n">space</span> <span class="p">(</span><span class="n">may</span> <span class="n">be</span> <span class="mi">0</span> <span class="nb">bytes</span> <span class="n">long</span><span class="p">)</span>                <span class="o">.</span> <span class="c1"># 空内存，不被使用</span>
</span></span><span class="line"><span class="cl">        <span class="o">.</span>                                                               <span class="o">.</span> <span class="c1"># 不过值并不一定为0</span>
</span></span><span class="line"><span class="cl"> <span class="nb">next</span>   <span class="o">.</span>                                                               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="n">chunk</span><span class="o">-&gt;</span> <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl"><span class="err">`</span><span class="n">foot</span><span class="p">:</span><span class="s1">' |             Size of chunk, in bytes                           | # 上一个chunk的大小</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span><span class="line"><span class="cl">        <span class="o">|</span>             <span class="n">Size</span> <span class="n">of</span> <span class="nb">next</span> <span class="n">chunk</span><span class="p">,</span> <span class="ow">in</span> <span class="nb">bytes</span>                <span class="o">|</span><span class="n">A</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span><span class="mi">0</span><span class="o">|</span> <span class="c1"># P位 置0</span>
</span></span><span class="line"><span class="cl">        <span class="o">+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
</span></span></code></pre></div><br/>
<ul>
<li>
<p>当我们向malloc申请一片内存区域时，这块内存区域就会在内存管理器 <strong>ptmalloc</strong> 以malloc_chunk结构体来表示，而且当我们释放这个堆块时，这个堆的数据结构依然是同一个，只是表现形式不同。</p>
</li>
<li>
<p>malloc 函数返回的是一个指针，一个对应大小字节的内存块的指针。</p>
</li>
<li>
<p>关于n的一些异常情况：</p>
<ul>
<li>
<p>当 n=0 时，返回当前系统允许的堆的最小内存块。（一般分配0x20的空间，prev_size + size + 数据对齐的0x10字节）</p>
</li>
<li>
<p>当 n 为负数时，由于在大多数系统上，<strong>size_t 是无符号数（这一点很重要）</strong>，所以程序就会申请很大的内存空间，但通常来说都会失败，因为系统没有那么多的内存可以分配。</p>
</li>
</ul>
</li>
<li>
<p>如果一个 chunk 处于 free 状态，那么会有两个位置记录其相应的大小</p>
<ul>
<li>
<p>该chunk自身的 size 字段</p>
</li>
<li>
<p>下一个chunk的prev_size字段</p>
</li>
</ul>
</li>
</ul>
<hr/>
<div class="anchor" id="堆的宏观结构"></div>
<h2 class="relative group">堆的宏观结构 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e5%a0%86%e7%9a%84%e5%ae%8f%e8%a7%82%e7%bb%93%e6%9e%84" style="text-decoration-line: none !important;">#</a></span>
</h2>
<p>~~复习一下，~~从总体上看可以把堆的数据结构分为微观结构和宏观结构：</p>
<ul>
<li>微观结构主要是<strong>malloc_chunk</strong>的数据与结构：
<ul>
<li>prev_size</li>
<li>size</li>
<li>fd，bk</li>
<li>fd_nextsize， bk_nextsize</li>
</ul>
</li>
<li>宏观结构包括堆块的宏观信息，可以使我们更好地了解glibc的堆管理实现，宏观结构分为以下几个部分：
<ul>
<li><strong>arena &amp; main_arena</strong>：可以看作是堆块的管理器，但其实就是<strong>堆内存本身</strong></li>
<li><strong>bin</strong>：用<strong>链表结构</strong>管理被free的malloc_chunk（堆块）</li>
<li><strong>top_chunk</strong>：处于一个arena的最顶部(即最高内存地址处)、不属于任何<strong>bin</strong>的一片内存</li>
<li><strong>malloc_state</strong>：管理 arena 的核心结构，包含堆的状态信息、bins 链表等
<ul>
<li>main arena 对应的 malloc state 结构存储在 glibc 全局变量中</li>
<li>其他线程 arena 对应的 malloc_state 存储在 arena 本身中</li>
</ul>
</li>
</ul>
</li>
</ul>
<hr/>
<div class="anchor" id="arena--main_arena"></div>
<h3 class="relative group"><strong>arena &amp; main_arena</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#arena--main_arena" style="text-decoration-line: none !important;">#</a></span>
</h3>
<ul>
<li>
<p>区分二者</p>
<ul>
<li>
<p><strong>arena</strong> 指的是堆内存区域本身，并不是结构；</p>
</li>
<li>
<p>主线程的 main arena 通过 sbrk 创建，管理所有堆块的结构体</p>
</li>
<li>
<p>其他线程的 arena 通过 mmap 创建，有时可能或会被<del>不恰当地</del>称为arena，存在于线程的控制块<strong>plt</strong>中</p>
</li>
<li>
<blockquote>
<p>不是每个线程都会有对应的arena
因为每个系统的核数有限，当线程数大于核数的二倍时，就必然有线程处于等待状态，所以没有必要为每个线程分配一个arena
32bit –&gt; arena_num = 2 * core
64bit –&gt; arena_num = 8 * core</p>
</blockquote>
</li>
</ul>
</li>
<li>
<p>主线程的 main arena和其他线程的 arena 可以看作是<strong>主分配区和非主分配区</strong></p>
<ul>
<li>ps：ptmalloc为什么要增加非主分配区？（问题与回答<strong>复制自</strong>：<a href="https://blog.csdn.net/sinat_19596835/article/details/81665095" target="_blank">
    malloc内存管理总结_</a>）</li>
<li>答：如果没有非主分配区，所有的线程在主分配区上操作，互相竞争锁的过程十分影响分配效率。ptmalloc中增加了非主分配区支持，主分配区和非主分配区用环形链表进行管理，提高malloc的分配效率。 申请小块内存时会产生很多内存碎片，ptmalloc在整理时也需要对分配区做加锁操作。每个加锁操作大概需要5～10个cpu指令，而且程序线程很多的情况下，锁等待的时间就会延长，导致malloc性能下降。一次加锁操作需要消耗100ns左右，正是锁的缘故，导致ptmalloc在多线程竞争情况下性能远远落后于tcmalloc。最新版的ptmalloc对锁进行了优化，加入了PER_THREAD和ATOMIC_FASTBINS优化，但默认编译不会启用该优化，这两个对锁的优化应该能够提升多线程内存的分配的效率。</li>
</ul>
</li>
<li>
<p>如何标志</p>
<ul>
<li>在malloc_chunk 中的  size 的倒数第三个标志位 A，多线程时为1，主线程为0</li>
<li>NON_MAIN_ARENA，<strong>A</strong>：size的倒数第三位表示当前chunk属于主分配区(0)还是非主分配区(1)</li>
</ul>
</li>
<li>
<p>子线程的堆和主线程的堆是不一样的</p>
<ul>
<li>每个线程都会预分配一个堆空间</li>
<li>线程会从这个对空间创建<strong>top_chunk</strong>和堆块</li>
<li>当malloc的空间超过预分配的大小，会回到main_arena之前再次分配一个空间</li>
<li>如果线程的堆存在溢出，可以用之前的chunk越界写堆的arena结构</li>
</ul>
</li>
</ul>
<p><strong>一些 tips</strong></p>
<ul>
<li>定位子线程的chunk的技巧</li>
</ul>
<ol>
<li>向子线程的堆块输入特殊值:“0xdeadbeef”</li>
<li>在gdb使用 <strong>search -4 0xdeadbeef</strong></li>
<li>搜索出来的地址即堆的地址</li>
</ol>
<br/>
<ul>
<li>多线程利用思路</li>
</ul>
<ol>
<li>在子线程中找到堆空间的地址空间A</li>
<li>在A中找到恢复线程的arena的结构</li>
<li>通过arena的结构尝试堆利用</li>
</ol>
<br/>
<div class="anchor" id="malloc_state"></div>
<h3 class="relative group"><strong>malloc_state</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#malloc_state" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>管理 arena 的核心结构，包含堆的状态信息、bins 链表等</p>
<ul>
<li>main arena 对应的 malloc state 结构存储在 glibc 全局变量中</li>
<li>其他线程 arena 对应的 malloc_state 存储在 arena 本身中</li>
</ul>
<p>Arena 头部结构：malloc_state 存储了 arena 的状态，其中的 bins[] 用于管理空闲块的 bins</p>
<div class="highlight"><pre class="chroma" tabindex="0"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">malloc_state</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Serialize access.  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">mutex_t</span> <span class="n">mutex</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Flags (formerly in max_fast).  */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Fastbins */</span>
</span></span><span class="line"><span class="cl">  <span class="n">mfastbinptr</span> <span class="n">fastbinsY</span><span class="p">[</span><span class="n">NFASTBINS</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Base of the topmost chunk -- not otherwise kept in a bin */</span>
</span></span><span class="line"><span class="cl">  <span class="n">mchunkptr</span> <span class="n">top</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* The remainder from the most recent split of a small request */</span>
</span></span><span class="line"><span class="cl">  <span class="n">mchunkptr</span> <span class="n">last_remainder</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Normal bins packed as described above */</span>
</span></span><span class="line"><span class="cl">  <span class="n">mchunkptr</span> <span class="n">bins</span><span class="p">[</span><span class="n">NBINS</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Bitmap of bins */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binmap</span><span class="p">[</span><span class="n">BINMAPSIZE</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Linked list */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">malloc_state</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Linked list for free arenas.  */</span>
</span></span><span class="line"><span class="cl">  <span class="k">struct</span> <span class="n">malloc_state</span> <span class="o">*</span><span class="n">next_free</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* Memory allocated from the system in this arena.  */</span>
</span></span><span class="line"><span class="cl">  <span class="n">INTERNAL_SIZE_T</span> <span class="n">system_mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">INTERNAL_SIZE_T</span> <span class="n">max_system_mem</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span></code></pre></div><p>主要关心这么几个：</p>
<ul>
<li><strong>mfastbinptr fastbinsY[NFASTBINS]</strong>，保存了 fastbins 各个链表的数组的头，大小为10 记录的是fast bin链</li>
<li><strong>mchunkptr top</strong>，指向了 top chunk</li>
<li><strong>mchunkptr bins[NBINS * 2 - 2]</strong>，大小为129。记录的是unsorted bin（1）、small bin（2~63）、large bin链（64~126）</li>
</ul>
<hr/>
<div class="anchor" id="bin"></div>
<h3 class="relative group"><strong>bin</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#bin" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>bin负责管理free的malloc_chunk，按照free的chunk大小划分为以下几种：</p>
<ul>
<li>fast bins，用于管理较小的 chunk</li>
<li>small bins，用于管理中等大小的 chunk</li>
<li>large bins，用于管理较大的 chunk</li>
<li>unsorted bin，用于存放未整理的 chunk</li>
<li><strong>tcache</strong>
<ul>
<li>是 glibc 2.26 (ubuntu 17.10) 之后引入的一种技术（see <a href="https://sourceware.org/git/?p=glibc.git;a=commitdiff;h=d5c3fafc4307c9b7a4c7d5cb381fcdbfad340bcc" target="_blank">
    commit</a>），目的是提升堆管理的性能。但提升性能的同时舍弃了很多安全检查，也因此有了很多新的利用方式。</li>
</ul>
</li>
</ul>
<br/>
<ul>
<li>管理流程</li>
</ul>
<ol>
<li>malloc/free –&gt; glibc –&gt; arena –&gt; fastbin/bins –&gt;smallbin/unsortedbin/largebin</li>
<li>从glibc找到main_arena</li>
<li>在main_arena的管理结构体malloc_state通过固定偏移中找到fastbinsY[NFASTBINS]，用以管理fastbin。</li>
<li>找到bins[NBINS * 2 - 2]，用以管理unsortedbin。</li>
</ol>
<br/>
<ul>
<li>bin的放置顺序</li>
</ul>
<blockquote>
<p>索引为1的是unsortedbin，这里面的chunk没有进行排序，比较杂乱。
索引从2到63的bin称为small bin，同一个small bin链表中的chunk的大小相同。两个相邻索引的small bin链表中的chunk大小为2个机器字节，即32–&gt;4字节，64–&gt;8字节。
索引从64到126的bin被称为large bin。large bins中的每一个bin都包含一定范围内的chunk，其中的chunk按fd指针的顺序从大到小排列，最靠近bin头的越大，相同大小的chunk按照最近使用顺序排列。</p>
</blockquote>
<br/>
<ul>
<li>任意两个物理相邻的空闲chunk不能在一起，否则会合并。</li>
</ul>
<br/>
<ul>
<li>free之后的chunk,与top_chunk相邻的,会与top_chunk合并，不与之相邻的,会根据其大小进入到不同的bin</li>
</ul>
<blockquote>
<p>小的进入fastbin，大的进入unsortedbin
此时，释放掉的chunk不会马上归还系统，ptmalloc会统一管理heap和mmap映射区域的空闲的chunk。
当用户再一次请求分配内存时，ptmalloc分配器会试图在空闲的chunk中挑选一块合适的给用户，这样可以避免频繁的系统调用，减少内存分配的开销。</p>
</blockquote>
<br/>
<ul>
<li>需要注意的是，并不是所有的chunk被释放之后立即放到bin中。ptmalloc为了提高分配的速度，会把一些小的堆块先放到fast bin的容器内。而且fast bin容器中的chunk的使用标记总是被置为1的，所以不会自动合并。</li>
</ul>
<hr/>
<div class="anchor" id="fastbin"></div>
<h4 class="relative group"><strong>fastbin</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#fastbin" style="text-decoration-line: none !important;">#</a></span>
</h4>
<p><strong>单向链表后进先出</strong>（LIFO），同时 p 位被保留（设置值为1）防止合并，同一大小的 chunk 会在同一条链上，不同大小的 chunk 在不同的链上</p>
<br/>
<p>不同平台大小不同，列一个索引，当 malloc 的大小在这个范围内的时候会首先去 fastbin 中找</p>
<table>
<thead>
<tr>
<th>fastbinsY[]（下标）</th>
<th>x86（size_t=4）</th>
<th>x64（size_t=8）</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0x10</td>
<td>0x20</td>
</tr>
<tr>
<td>1</td>
<td>0x18</td>
<td>0x30</td>
</tr>
<tr>
<td>2</td>
<td>0x20</td>
<td>0x40</td>
</tr>
<tr>
<td>3</td>
<td>0x28</td>
<td>0x50</td>
</tr>
<tr>
<td>4</td>
<td>0x30</td>
<td>0x60</td>
</tr>
<tr>
<td>5</td>
<td>0x38</td>
<td>0x70</td>
</tr>
<tr>
<td>6</td>
<td>0x40</td>
<td>0x80</td>
</tr>
</tbody>
</table>
<ul>
<li>注意fastbin不属于bins，不是bins管理的</li>
<li>fashbin是ptmalloc单独用来管理<strong>0x20-0x80</strong>（64位平台）的堆块的数据结构，如果free的chunk大小在0x20-0x80之间，会优先进入fashbin</li>
<li>fastbin 为单向链表，只有fd指针，没有bk指针
<ul>
<li>0x602080 –&gt; 0x602040 –&gt; 0x602000 –&gt; 0x0</li>
</ul>
</li>
</ul>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/ot6bzZF8ScXuQ2d.png"/>
</figure>
</p>
<hr/>
<div class="anchor" id="unsortedbin"></div>
<h4 class="relative group"><strong>unsortedbin</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#unsortedbin" style="text-decoration-line: none !important;">#</a></span>
</h4>
<p>堆块中转站</p>
<ul>
<li><strong>双向循环链表，先进先出</strong>（FIFO）</li>
<li>存放所有不满足 fastbin，未被整理的 chunk
<ul>
<li>除了fastbin管理的<strong>小</strong>堆块，free掉的chunk都是先进入到unsortedbin里再进行整理</li>
</ul>
</li>
<li>malloc 的时候在其他 bin 没找到合适的就会遍历 unsortedbin 同时根据大小放到对应的 bin 里</li>
<li>在整理过程中，先将所有放在unsortedbin链上的堆块按照大小整理到其它链上</li>
<li>将fastbin上的碎片整理到unsorted,再由unsorted整理到其他bin链</li>
<li>由于使用双链表，一个bin会占用bins的两个元素。fd指向上一个chunk，bk指向下一个</li>
</ul>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/zRs5QM2j1Ymy8WO.png"/>
</figure>
</p>
<hr/>
<div class="anchor" id="smallbin"></div>
<h4 class="relative group"><strong>smallbin</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#smallbin" style="text-decoration-line: none !important;">#</a></span>
</h4>
<ul>
<li>大小在0x20-0x400（64位）</li>
</ul>
<table>
<thead>
<tr>
<th>下标</th>
<th>x86（size_t=4）</th>
<th>x64（size_t=8）</th>
</tr>
</thead>
<tbody>
<tr>
<td>2</td>
<td>0x10</td>
<td>0x20</td>
</tr>
<tr>
<td>3</td>
<td>0x18</td>
<td>0x30</td>
</tr>
<tr>
<td>4</td>
<td>0x20</td>
<td>0x40</td>
</tr>
<tr>
<td>5</td>
<td>0x28（40）</td>
<td>0x50（80）</td>
</tr>
<tr>
<td>x</td>
<td>2 * 4 * x</td>
<td>2 * 8 * x</td>
</tr>
<tr>
<td>63</td>
<td>0x1F8（504）</td>
<td>0x3F0（1008）</td>
</tr>
</tbody>
</table>
<ul>
<li><strong>双向链表，先进先出</strong>（FIFO）</li>
<li>由于fast bin和small bin 有重合部分，在某些情况下会加入到small bin</li>
<li>释放的时候会检查相邻的是不是 free 的，如果是进行<strong>合并</strong>然后放到 <strong>unsortedbin</strong></li>
</ul>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/ExMuhDnAcQKrCH8.png"/>
</figure>
</p>
<hr/>
<div class="anchor" id="largebin"></div>
<h4 class="relative group"><strong>largebin</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#largebin" style="text-decoration-line: none !important;">#</a></span>
</h4>
<ul>
<li>管理大于0x400的堆块（64位），大于0x200的堆块（32位）</li>
<li><strong>双向链表，先进先出</strong>（FIFO）</li>
<li>free时bk后面多两个此参数：fd_nextsize、bk_nextsize</li>
<li>fd_nextsize和bk_nextsize指针用于指向第一个与自己大小不同的chunk，所以也只有在加入了大小不同的chunk时，这两个指针才会被修改</li>
</ul>
<br/>
<hr/>
<div class="anchor" id="top-chunk"></div>
<h3 class="relative group"><strong>top chunk</strong>
<span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#top-chunk" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>当我们分配一块堆内存时，top chunk是处于地址的<strong>最高处的</strong>，其前面就是我们所申请的chunk</p>
<p>
<figure>
<img alt="image-20230830002711964" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/lOyrKJ3THn2ZYQo.png"/>
</figure>
</p>
<br/>
<p>top chunk的结构：</p>
<p>
<figure>
<img alt="img" class="my-0 rounded-md" src="https://s2.loli.net/2023/08/30/J8YGdjiR7hQblfB.png"/>
</figure>
</p>
<ul>
<li>size：top chunk还有多少空间可以分配。</li>
<li>重要的是P位：0表示上一堆块处于空闲，1表示上一堆块处于使用状态。主要用于判断free时是否能与上一堆块进行合并（fastbin除外）</li>
<li>top chunk的合并操作
<ul>
<li>如果top chunk前面的chunk不是fast chunk并且处于空闲，那么top chunk就会合并这个chunk。</li>
<li>如果top chunk前面的chunk是fast chunk，不论是否空闲，top chunk都不会合并这个chunk</li>
</ul>
</li>
<li>阻止top chunk合并chunk
<ul>
<li>如果在一个free掉的chunk后面再申请一个chunk，那么新申请的chunk处于使用状态，top chunk就不会合并前面的chunk。</li>
</ul>
</li>
</ul>
<p>补充：</p>
<p>last remainder chunk</p>
<ul>
<li>Last remainder chunk是另外一种特殊的chunk，这个特殊chunk是被维护在unsorted bin中的</li>
<li>在malloc时，如果有比较大的chunk可以分配，会把这个chunk分成两部分，一部分返回给用户，另一部分称为remainder，加入到 unsorted bin，last remainder会记录最近拆分的remainder。这个remainder大小至少要为MINSIZE，否则不能拆分。</li>
<li>当下次malloc时，如果last remainder chunk够大，则重复上一过程。</li>
<li>拆分的情况：fast bin 和 small bin 都没有合适的chunk，同时unsorted bin有且只有一个可拆分的chunk，并且这个chunk 是last remainder</li>
</ul>
<br/>
<hr/>
<div class="anchor" id="附录"></div>
<h3 class="relative group">附录 
    <span class="absolute top-0 w-6 transition-opacity opacity-0 ltr:-left-6 rtl:-right-6 not-prose group-hover:opacity-100">
<a aria-label="锚点" class="group-hover:text-primary-300 dark:group-hover:text-neutral-700" href="#%e9%99%84%e5%bd%95" style="text-decoration-line: none !important;">#</a></span>
</h3>
<p>学习与参考链接：</p>
<p><a href="https://ctf-wiki.org/pwn/linux/user-mode/heap/ptmalloc2/heap-structure/" target="_blank">
    堆相关数据结构 - CTF Wiki (ctf-wiki.org)</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/77312725" target="_blank">
    二进制安全之堆溢出（系列）——堆基础 &amp; 结构（一）</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/77316206" target="_blank">
    二进制安全之堆溢出（系列）——堆基础 &amp; 结构（二）</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/77320388" target="_blank">
    二进制安全之堆溢出（系列）——堆基础 &amp; 结构（三）</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/77322810" target="_blank">
    二进制安全之堆溢出（系列）——堆基础 &amp; 结构（四）</a></p>
<p><a href="https://www.yuque.com/hxfqg9/bin/nvrgrs#ZQEAX" target="_blank">
    堆相关知识 (yuque.com)</a></p>
<p><a href="https://blog.csdn.net/sinat_19596835/article/details/81665095" target="_blank">
    malloc内存管理总结_g_malloc是怎么进行内存管理的</a></p>
<p>（注：本文部分图片来源于unr4v31师傅的<a href="https://www.cnblogs.com/unr4v31/p/14446412.html" target="_blank">
    文章</a>）</p>
<br/>
<br/>
<details class="mt-2 mb-5 overflow-hidden rounded-lg ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5" style="margin-left:0px">
<summary class="py-1 text-lg font-semibold cursor-pointer bg-primary-200 text-neutral-800 ltr:-ml-5 ltr:pl-5 rtl:-mr-5 rtl:pr-5 dark:bg-primary-800 dark:text-neutral-100">
        堆学习记录 - This article is part of a series.
    </summary>
<div class="py-1 border-dotted border-neutral-300 ltr:-ml-5 ltr:border-l ltr:pl-5 rtl:-mr-5 rtl:border-r rtl:pr-5 dark:border-neutral-600">
        Part 1: This Article
    </div>
</details>
</div>
<script>
        var oid = "views_posts\\pwn\\heap\\chunk_1\\index.md"
        var oid_likes = "likes_posts\\pwn\\heap\\chunk_1\\index.md"
      </script>
<script integrity="sha512-DkmXO0rQo4LHxgEti/+CJjFmQtqrxPiiBHe9CGdPPabi+pk7wgrU9R58W7aOb5E6IHp8T+N+oOe4BolK/OCmTg==" src="/js/page.min.0e49973b4ad0a382c7c6012d8bff8226316642daabc4f8a20477bd08674f3da6e2fa993bc20ad4f51e7c5bb68e6f913a207a7c4fe37ea0e7b806894afce0a64e.js" type="text/javascript"></script>
</section>
<footer class="pt-8 max-w-prose print:hidden">
<h2 class="mt-8 text-2xl font-extrabold mb-10">Related</h2>
<section class="w-full grid gap-4 sm:grid-cols-2 md:grid-cols-3">
<a class="min-w-full" href="/posts/pwn/risc-v/0x01/">
<div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur">
<div class="px-6 py-4">
<div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href="/posts/pwn/risc-v/0x01/">RISC-V PWN学习</div>
<div class="text-sm text-neutral-500 dark:text-neutral-400">
<div class="flex flex-row flex-wrap items-center">
<time datetime="2023-09-03 00:00:00 +0000 UTC">September 3, 2023</time><span class="px-2 text-primary-500">·</span><span>11267 字</span><span class="px-2 text-primary-500">·</span><span title="预计阅读">23 分钟</span>
</div>
<div class="flex flex-row flex-wrap items-center">
<span class="mr-2" onclick="window.open(&quot;/categories/pwn%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN学习记录
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/ctf/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CTF
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/pwn/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/riscv64/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    riscv64
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/%E5%BC%82%E6%9E%84pwn/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    异构PWN
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/iot/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    IoT
  </span>
</span>
</span>
</div>
</div>
</div>
<div class="px-6 pt-4 pb-2">
</div>
</div>
</a>
<a class="min-w-full" href="/posts/pwn/awdp/0x02/">
<div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur">
<div class="w-full thumbnail_card_related nozoom" style="background-image:url(/posts/pwn/awdp/0x02/featured.jpg);"></div>
<div class="px-6 py-4">
<div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href="/posts/pwn/awdp/0x02/">从0到0.002的AWDP实战记录</div>
<div class="text-sm text-neutral-500 dark:text-neutral-400">
<div class="flex flex-row flex-wrap items-center">
<time datetime="2023-09-11 00:00:00 +0000 UTC">September 11, 2023</time><span class="px-2 text-primary-500">·</span><span>1967 字</span><span class="px-2 text-primary-500">·</span><span title="预计阅读">4 分钟</span>
</div>
<div class="flex flex-row flex-wrap items-center">
<span class="mr-2" onclick="window.open(&quot;/categories/pwn%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN学习记录
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/ctf/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CTF
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/pwn/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/awdp/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    AWDP
  </span>
</span>
</span>
</div>
</div>
</div>
<div class="px-6 pt-4 pb-2">
</div>
</div>
</a>
<a class="min-w-full" href="/posts/pwn/awdp/0x01/">
<div class="min-h-full border border-neutral-200 dark:border-neutral-700 border-2 rounded overflow-hidden shadow-2xl relative backdrop-blur">
<div class="w-full thumbnail_card_related nozoom" style="background-image:url(/posts/pwn/awdp/0x01/featured.jpg);"></div>
<div class="px-6 py-4">
<div class="font-bold text-xl text-neutral-800 decoration-primary-500 hover:underline hover:underline-offset-2 dark:text-neutral" href="/posts/pwn/awdp/0x01/">从0到0.001的AWDP学习记录</div>
<div class="text-sm text-neutral-500 dark:text-neutral-400">
<div class="flex flex-row flex-wrap items-center">
<time datetime="2023-09-04 00:00:00 +0000 UTC">September 4, 2023</time><span class="px-2 text-primary-500">·</span><span>3381 字</span><span class="px-2 text-primary-500">·</span><span title="预计阅读">7 分钟</span>
</div>
<div class="flex flex-row flex-wrap items-center">
<span class="mr-2" onclick="window.open(&quot;/categories/pwn%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN学习记录
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/ctf/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    CTF
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/pwn/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    PWN
  </span>
</span>
</span>
<span class="mr-2" onclick="window.open(&quot;/tags/awdp/&quot;,'_self');" style="margin-top:0.5rem">
<span class="flex">
<span class="rounded-md border border-primary-400 px-1 py-[1px] text-xs font-normal text-primary-700 dark:border-primary-600 dark:text-primary-400">
    AWDP
  </span>
</span>
</span>
</div>
</div>
</div>
<div class="px-6 pt-4 pb-2">
</div>
</div>
</a>
</section>
<div class="content" id="content">
<div style="margin-top:2em;padding:0 0.5em;font-size:.875rem">
<hr/>
<br/>
<div style="padding-bottom:1em;">
<p> </p>
<p>本文作者：<a href="https://ta0lve.github.io/about/" target="_blank"><font color="#49b1f5" style="text-decoration: underline">ta0lve</font></a></p>
<p>本文链接：<a href="https://ta0lve.github.io/posts/pwn/heap/chunk_1/" target="_blank"><font color="#49b1f5" style="text-decoration: underline">堆基础知识学习记录</font></a></p>
<p><a href="https://ta0lve.github.io/posts/pwn/heap/chunk_1/" target="_blank"><font color="#49b1f5" style="text-decoration: underline"> https://ta0lve.github.io/posts/pwn/heap/chunk_1/ </font></a></p>
<p>版权声明：本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc/4.0/" target="_blank"><font color="#49b1f5" style="text-decoration: underline"> CC BY-NC 4.0 </font></a> 许可协议。</p>
<p>转载请注明来自<a class="redlink" href="https://ta0lve.github.io/" target="_blank"> <font color="#49b1f5" style="text-decoration: underline">ta0lve's Blog</font></a> ！</p>
</div>
</div>
</div>
<div class="pt-8">
<hr class="border-dotted border-neutral-300 dark:border-neutral-600"/>
<div class="flex justify-between pt-3">
<span>
<a class="flex group mr-3" href="/posts/pwn/basic/linux_/">
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">←</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">→</span>
<span class="flex flex-col">
<span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">Linux命令入门与总结</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
<time datetime="2023-07-14 00:00:00 +0000 UTC">July 14, 2023</time>
</span>
</span>
</a>
</span>
<span>
<a class="flex text-right group ml-3" href="/posts/pwn/basic/tutorial22/">
<span class="flex flex-col">
<span class="mt-[0.1rem] leading-6 group-hover:underline group-hover:decoration-primary-500">pwn入门教程</span>
<span class="mt-[0.1rem] text-xs text-neutral-500 dark:text-neutral-400">
<time datetime="2023-08-05 00:00:00 +0000 UTC">August 5, 2023</time>
</span>
</span>
<span class="ml-3 text-neutral-700 group-hover:text-primary-600 ltr:inline rtl:hidden dark:text-neutral dark:group-hover:text-primary-400">→</span>
<span class="mr-3 text-neutral-700 group-hover:text-primary-600 ltr:hidden rtl:inline dark:text-neutral dark:group-hover:text-primary-400">←</span>
</a>
</span>
</div>
</div>
<script async="" crossorigin="anonymous" data-category="Announcements" data-category-id="DIC_kwDOJ9Vlo84CX_0P" data-emit-metadata="0" data-input-position="bottom" data-lang="zh-CN" data-mapping="pathname" data-reactions-enabled="1" data-repo="ta0lve/blogtalk" data-repo-id="R_kgDOJ9Vlow" data-strict="0" data-theme="dark_dimmed" src="https://giscus.app/client.js">
</script>
</footer>
</article>
<div class="pointer-events-none absolute top-[110vh] bottom-0 w-12 ltr:right-0 rtl:left-0" id="top-scroller">
<a aria-label="" class="pointer-events-auto sticky top-[calc(100vh-5.5rem)] flex h-12 w-12 mb-16 items-center justify-center rounded-full bg-neutral/50 text-xl text-neutral-700 backdrop-blur hover:text-primary-600 dark:bg-neutral-800/50 dark:text-neutral dark:hover:text-primary-400" href="#the-top" title="">
    ↑
  </a>
</div>
</main><footer class="py-10 print:hidden" id="site-footer">
<nav class="flex flex-row pb-4 text-base font-medium text-neutral-500 dark:text-neutral-400">
<ul class="flex flex-col list-none sm:flex-row">
<li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
<a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/about/" title="About">About</a>
</li>
<li class="flex mb-1 ltr:text-right rtl:text-left sm:mb-0 ltr:sm:mr-7 ltr:sm:last:mr-0 rtl:sm:ml-7 rtl:sm:last:ml-0">
<a class="decoration-primary-500 hover:underline hover:decoration-2 hover:underline-offset-2" href="/tags/pwn/" title="PWN">pwn2own , pwn4fun</a>
</li>
</ul>
</nav>
<div class="flex items-center justify-between">
<p class="text-sm text-neutral-500 dark:text-neutral-400">
      Copyright ©2024 ta0lve, All Rights Reserved.
    </p>
<p class="text-xs text-neutral-500 dark:text-neutral-400">
      
      
      由 <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &amp; <a class="hover:underline hover:decoration-primary-400 hover:text-primary-500" href="https://blowfish.page/" rel="noopener noreferrer" target="_blank">Blowfish</a> 强力驱动
    </p>
</div>
<script>
    
    mediumZoom(document.querySelectorAll("img:not(.nozoom)"), {
      margin: 24,
      background: 'rgba(0,0,0,0.5)',
      scrollOffset: 0,
    })
    
  </script>
<script integrity="sha512-NcERO8wWxaWb8DEIL55jgiqpUoBCOIGnhHp/8zoW5imc5qhA2e9OENlH4DChjz8gNZr7LsDzWWdIS5qTYKwxRQ==" src="/js/process.min.35c1113bcc16c5a59bf031082f9e63822aa95280423881a7847a7ff33a16e6299ce6a840d9ef4e10d947e030a18f3f20359afb2ec0f35967484b9a9360ac3145.js" type="text/javascript"></script>
</footer><div class="invisible fixed inset-0 flex h-screen w-screen cursor-default flex-col bg-neutral-500/50 p-4 backdrop-blur-sm dark:bg-neutral-900/50 sm:p-6 md:p-[10vh] lg:p-[12vh]" data-url="https://ta0lve.github.io/" id="search-wrapper" style="z-index:500">
<div class="flex flex-col w-full max-w-3xl min-h-0 mx-auto border rounded-md shadow-lg top-20 border-neutral-200 bg-neutral dark:border-neutral-700 dark:bg-neutral-800" id="search-modal">
<header class="relative z-10 flex items-center justify-between flex-none px-2">
<form class="flex items-center flex-auto min-w-0">
<div class="flex items-center justify-center w-8 h-8 text-neutral-400">
<span class="relative block icon">
<svg aria-hidden="true" class="svg-inline--fa fa-search fa-w-16" data-icon="search" data-prefix="fas" focusable="false" role="img" viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><path d="M505 442.7L405.3 343c-4.5-4.5-10.6-7-17-7H372c27.6-35.3 44-79.7 44-128C416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c48.3 0 92.7-16.4 128-44v16.3c0 6.4 2.5 12.5 7 17l99.7 99.7c9.4 9.4 24.6 9.4 33.9 0l28.3-28.3c9.4-9.4 9.4-24.6.1-34zM208 336c-70.7 0-128-57.2-128-128 0-70.7 57.2-128 128-128 70.7 0 128 57.2 128 128 0 70.7-57.2 128-128 128z" fill="currentColor"></path></svg>
</span>
</div>
<input class="flex flex-auto h-12 mx-1 bg-transparent appearance-none focus:outline-dotted focus:outline-2 focus:outline-transparent" id="search-query" placeholder="" tabindex="0" type="search"/>
</form>
<button class="flex items-center justify-center w-8 h-8 text-neutral-700 hover:text-primary-600 dark:text-neutral dark:hover:text-primary-400" id="close-search-button" title="">
<span class="relative block icon">
<svg viewbox="0 0 320 512" xmlns="http://www.w3.org/2000/svg"><path d="M310.6 361.4c12.5 12.5 12.5 32.75 0 45.25C304.4 412.9 296.2 416 288 416s-16.38-3.125-22.62-9.375L160 301.3L54.63 406.6C48.38 412.9 40.19 416 32 416S15.63 412.9 9.375 406.6c-12.5-12.5-12.5-32.75 0-45.25l105.4-105.4L9.375 150.6c-12.5-12.5-12.5-32.75 0-45.25s32.75-12.5 45.25 0L160 210.8l105.4-105.4c12.5-12.5 32.75-12.5 45.25 0s12.5 32.75 0 45.25l-105.4 105.4L310.6 361.4z" fill="currentColor"></path></svg>
</span>
</button>
</header>
<section class="flex-auto px-2 overflow-auto">
<ul id="search-results">
</ul>
</section>
</div>
</div>
</div>
</body>
</html>
